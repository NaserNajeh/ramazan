<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ù…Ø­Ø§Ø³Ø¨Ø© Ø±Ù…Ø¶Ø§Ù†</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b5d4a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ù…Ø­Ø§Ø³Ø¨Ø© Ø±Ù…Ø¶Ø§Ù†">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    :root {
      --bg1: #041513;
      --bg2: #0b5d4a;
      --glass: rgba(255, 255, 255, .10);
      --glass2: rgba(255, 255, 255, .16);
      --stroke: rgba(255, 255, 255, .18);
      --text: rgba(255, 255, 255, .92);
      --muted: rgba(255, 255, 255, .72);
      --gold: #d8b35a;
      --mint: #1fbf9a;
      --shadow: 0 22px 60px rgba(0, 0, 0, .35);
      --radius: 18px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: 'Tajawal', system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(216, 179, 90, .28), transparent 58%),
        radial-gradient(900px 700px at 90% 20%, rgba(31, 191, 154, .22), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text);
      overflow-x: hidden;
    }

    /* ØªÙˆÙ‡Ø¬ ÙˆØ£Ø´Ø¹Ø© Ù…ØªØ­Ø±ÙƒØ© */
    .glow-layer {
      position: fixed;
      inset: -30vh -30vw;
      pointer-events: none;
      filter: blur(24px);
      opacity: .75;
      z-index: 0;
    }

    .glow-layer::before,
    .glow-layer::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(closest-side at 20% 25%, rgba(216, 179, 90, .35), transparent 65%),
        radial-gradient(closest-side at 80% 20%, rgba(31, 191, 154, .28), transparent 60%),
        radial-gradient(closest-side at 55% 80%, rgba(255, 255, 255, .10), transparent 70%);
      animation: floatGlow 10s ease-in-out infinite alternate;
      transform: translate3d(0, 0, 0);
    }

    .glow-layer::after {
      background:
        radial-gradient(closest-side at 30% 70%, rgba(31, 191, 154, .22), transparent 62%),
        radial-gradient(closest-side at 75% 60%, rgba(216, 179, 90, .24), transparent 62%);
      animation-duration: 14s;
      opacity: .8;
      mix-blend-mode: screen;
    }

    @keyframes floatGlow {
      0% {
        transform: translate(-2%, -1%) scale(1.02) rotate(0deg);
      }

      100% {
        transform: translate(2%, 1.5%) scale(1.06) rotate(2deg);
      }
    }

    .beams {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: .55;
      z-index: 1;
      mix-blend-mode: screen;
    }

    .beam {
      position: absolute;
      width: 55vw;
      height: 140vh;
      top: -20vh;
      left: -10vw;
      background: linear-gradient(180deg,
          rgba(216, 179, 90, 0) 0%,
          rgba(216, 179, 90, .10) 30%,
          rgba(31, 191, 154, .10) 55%,
          rgba(216, 179, 90, 0) 100%);
      transform: rotate(18deg);
      filter: blur(10px);
      animation: beamMove 9s linear infinite;
    }

    .beam.b2 {
      left: 35vw;
      width: 45vw;
      transform: rotate(-12deg);
      animation-duration: 11s;
      opacity: .45;
      background: linear-gradient(180deg,
          rgba(31, 191, 154, 0) 0%,
          rgba(31, 191, 154, .14) 38%,
          rgba(216, 179, 90, .10) 58%,
          rgba(31, 191, 154, 0) 100%);
    }

    @keyframes beamMove {
      0% {
        transform: translateY(-6vh) rotate(18deg);
        opacity: .30;
      }

      30% {
        opacity: .65;
      }

      100% {
        transform: translateY(10vh) rotate(18deg);
        opacity: .35;
      }
    }

    /* Ø²Ø®Ø±ÙØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ© */
    .ornament-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: .16;
      z-index: 1;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><defs><pattern id="p" width="64" height="64" patternUnits="userSpaceOnUse"><path d="M32 6 L46 20 L58 32 L46 44 L32 58 L18 44 L6 32 L18 20 Z" fill="none" stroke="%23d8b35a" stroke-width="1.2"/><circle cx="32" cy="32" r="6" fill="none" stroke="%23ffffff" stroke-opacity=".35" stroke-width="1"/><path d="M32 14 C42 14 50 22 50 32 C50 42 42 50 32 50 C22 50 14 42 14 32 C14 22 22 14 32 14 Z" fill="none" stroke="%231fbf9a" stroke-opacity=".55" stroke-width="1"/></pattern></defs><rect width="200" height="200" fill="url(%23p)"/></svg>');
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 14px 12px 12px;
      backdrop-filter: blur(14px);
      background: linear-gradient(135deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .05));
      border-bottom: 1px solid rgba(255, 255, 255, .12);
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 10px;
      position: relative;
      z-index: 2;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand h1 {
      margin: 0;
      font-size: 15px;
      line-height: 1.2;
    }

    .brand .sub {
      margin-top: 2px;
      font-size: 11px;
      color: var(--muted);
    }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      background: rgba(255, 255, 255, .10);
      border: 1px solid rgba(255, 255, 255, .16);
      color: #fff;
      white-space: nowrap;
      box-shadow: 0 10px 22px rgba(0, 0, 0, .14);
    }

    .chip.gold {
      background: rgba(216, 179, 90, .14);
      border-color: rgba(216, 179, 90, .25);
    }

    .chip.mint {
      background: rgba(31, 191, 154, .12);
      border-color: rgba(31, 191, 154, .22);
    }

    .icon {
      width: 36px;
      height: 36px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      background: rgba(216, 179, 90, .14);
      border: 1px solid rgba(216, 179, 90, .24);
      box-shadow: 0 12px 26px rgba(0, 0, 0, .18);
      overflow: hidden;
    }

    .icon img {
      width: 28px;
      height: 28px;
      border-radius: 10px;
    }

    main {
      padding: 14px 0 28px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 860px) {
      .grid {
        grid-template-columns: 1.1fr .9fr;
        align-items: start;
      }
    }

    .card {
      background: linear-gradient(135deg, rgba(255, 255, 255, .16), rgba(255, 255, 255, .10));
      border: 1px solid rgba(255, 255, 255, .18);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(16px);
    }

    .cardHead {
      padding: 12px 12px 10px;
      background: linear-gradient(135deg, rgba(216, 179, 90, .12), rgba(31, 191, 154, .10));
      border-bottom: 1px solid rgba(255, 255, 255, .14);
    }

    .cardHead h2 {
      margin: 0;
      font-size: 14px;
    }

    .cardBody {
      padding: 12px;
    }

    .navRow {
      display: grid;
      grid-template-columns: 1fr 1.4fr 1fr;
      gap: 10px;
      align-items: center;
    }

    .btn {
      border: 1px solid rgba(255, 255, 255, .18);
      background: linear-gradient(135deg, rgba(255, 255, 255, .14), rgba(255, 255, 255, .08));
      padding: 11px 12px;
      border-radius: 14px;
      font-weight: 900;
      cursor: pointer;
      color: #fff;
      box-shadow: 0 10px 22px rgba(0, 0, 0, .18);
      transition: transform .08s ease, filter .15s ease;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, .25), transparent 55%);
      transform: translateX(-30%);
      opacity: .0;
      transition: opacity .2s ease;
    }

    .btn:hover::after {
      opacity: .55;
    }

    .btn:active {
      transform: scale(.99);
    }

    .btn.primary {
      background: linear-gradient(135deg, rgba(31, 191, 154, .18), rgba(11, 93, 74, .18));
      border-color: rgba(31, 191, 154, .26);
    }

    .btn.danger {
      background: linear-gradient(135deg, rgba(255, 107, 107, .18), rgba(216, 179, 90, .08));
      border-color: rgba(255, 107, 107, .26);
    }

    .btn:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .centerInfo {
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .18);
      background: linear-gradient(135deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
      text-align: center;
      backdrop-filter: blur(12px);
    }

    .centerInfo .d1 {
      font-weight: 900;
      font-size: 14px;
    }

    .centerInfo .d2 {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .badges {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(255, 255, 255, .18);
      background: rgba(255, 255, 255, .10);
      color: #fff;
    }

    .badge.ok {
      background: rgba(31, 191, 154, .12);
      border-color: rgba(31, 191, 154, .24);
    }

    .badge.warn {
      background: rgba(216, 179, 90, .14);
      border-color: rgba(216, 179, 90, .28);
    }

    .badge.miss {
      background: rgba(0, 0, 0, .12);
      border-color: rgba(255, 255, 255, .16);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .16);
      background: linear-gradient(135deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
      backdrop-filter: blur(12px);
    }

    .item .meta {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .item label {
      font-size: 13px;
      font-weight: 900;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
    }

    input[type="checkbox"] {
      width: 22px;
      height: 22px;
      accent-color: var(--mint);
    }

    .scaleBox {
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .16);
      background: linear-gradient(135deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
      backdrop-filter: blur(12px);
    }

    .scaleTop {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 7px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      background: rgba(255, 255, 255, .10);
      border: 1px solid rgba(255, 255, 255, .16);
    }

    input[type="range"] {
      width: 100%;
      margin-top: 10px;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .16);
      padding: 12px;
      font-size: 13px;
      background: rgba(0, 0, 0, .10);
      color: #fff;
      outline: none;
      backdrop-filter: blur(10px);
    }

    textarea::placeholder {
      color: rgba(255, 255, 255, .65);
    }

    textarea:focus {
      border-color: rgba(31, 191, 154, .45);
      box-shadow: 0 0 0 4px rgba(31, 191, 154, .12);
    }

    details summary {
      cursor: pointer;
      list-style: none;
      user-select: none;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .16);
      background: linear-gradient(135deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
      font-weight: 900;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details .inside {
      padding: 10px 4px 0;
    }

    .tableWrap {
      overflow: auto;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .16);
      background: rgba(0, 0, 0, .10);
      backdrop-filter: blur(10px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
      color: #fff;
    }

    th,
    td {
      border: 1px solid rgba(255, 255, 255, .10);
      padding: 8px;
      font-size: 12px;
      text-align: center;
    }

    th {
      background: linear-gradient(135deg, rgba(216, 179, 90, .18), rgba(31, 191, 154, .12));
      position: sticky;
      top: 0;
      z-index: 5;
      font-weight: 900;
    }

    tr:hover td {
      background: rgba(31, 191, 154, .06);
    }

    .footerNote {
      text-align: center;
      color: rgba(255, 255, 255, .72);
      font-size: 11px;
      margin-top: 12px;
    }

    .installBar {
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: 10px;
      z-index: 9999;
      display: none;
      gap: 10px;
      align-items: center;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, .18);
      background: linear-gradient(135deg, rgba(255, 255, 255, .14), rgba(255, 255, 255, .08));
      backdrop-filter: blur(16px);
      box-shadow: 0 22px 60px rgba(0, 0, 0, .35);
    }

    .installBar .txt {
      flex: 1;
      min-width: 160px;
    }

    .installBar .t1 {
      font-weight: 900;
      font-size: 13px;
    }

    .installBar .t2 {
      margin-top: 2px;
      font-size: 11px;
      color: var(--muted);
    }

    .installBar .actions {
      display: flex;
      gap: 8px;
    }

    .installBar .miniBtn {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .18);
      background: rgba(0, 0, 0, .12);
      color: #fff;
      font-weight: 900;
      cursor: pointer;
    }

    .installBar .miniBtn.ok {
      background: linear-gradient(135deg, rgba(31, 191, 154, .22), rgba(11, 93, 74, .22));
      border-color: rgba(31, 191, 154, .28);
    }

    /* PDF Modal */
    .modal {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0, 0, 0, .85);
      backdrop-filter: blur(10px);
      display: none;
      flex-direction: column;
      animation: fadeIn .2s ease;
    }

    .modal.open {
      display: flex;
    }

    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg2);
      border-bottom: 1px solid var(--stroke);
      color: #fff;
    }

    .pdf-container {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: #e8e8e8;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 4px 0;
    }

    .pdf-container canvas {
      max-width: 100%;
      height: auto !important;
      display: block;
    }

    .pdf-loading {
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-family: 'Tajawal', sans-serif;
      font-size: 18px;
    }

    .close-btn {
      background: rgba(0, 0, 0, .2);
      border: 1px solid rgba(255, 255, 255, .2);
      color: #fff;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <div class="glow-layer"></div>
  <div class="beams">
    <div class="beam"></div>
    <div class="beam b2"></div>
  </div>
  <div class="ornament-bg"></div>

  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="icon" aria-hidden="true"><img src="./icon-192.png" alt="Ø±Ù…Ø¶Ø§Ù†"></div>
          <div>
            <h1>Ù…Ø­Ø§Ø³Ø¨Ø© Ø±Ù…Ø¶Ø§Ù†</h1>
            <div class="sub">Ø¬Ø¯ÙˆÙ„ ØªÙØ§Ø¹Ù„ÙŠ â€¢ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ â€¢ ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</div>
          </div>
        </div>
        <div class="chips">
          <span class="chip gold" id="ramadanChip">1 Ø±Ù…Ø¶Ø§Ù†</span>
          <span class="chip" id="gregChip">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ 18/2/2026</span>
          <span class="chip mint" id="scoreChip">0%</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid">
        <section class="card">
          <div class="cardHead">
            <h2>Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…</h2>
          </div>
          <div class="cardBody">
            <div class="navRow">
              <button class="btn" id="prevDay">Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
              <div class="centerInfo">
                <div class="d1" id="dayTitle">Ø§Ù„ÙŠÙˆÙ… 1 Ø±Ù…Ø¶Ø§Ù†</div>
                <div class="d2" id="dayDate">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ 18/2/2026</div>
                <div class="badges">
                  <span class="badge miss" id="statusBadge">ØºÙŠØ± Ù…ÙƒØªÙ…Ù„</span>
                  <span class="badge" id="boolBadge">0 / 13</span>
                  <span class="badge" id="prayersBadge">Ø§Ù„ØµÙ„Ø§Ø©: 0/5</span>
                </div>
              </div>
              <button class="btn" id="nextDay">Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <div style="height:10px"></div>
            <div class="list" id="itemsList"></div>

            <div style="height:12px"></div>
            <div class="scaleBox">
              <div class="scaleTop">
                <div style="display:flex; flex-direction:column; gap:3px;">
                  <div style="font-weight:900;">Ø§Ù„ØµÙ„Ø§Ø© Ø¹Ù„Ù‰ ÙˆÙ‚ØªÙ‡Ø§ / 5</div>
                  <div class="hint">Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø®Ù…Ø³ ÙÙŠ ÙˆÙ‚ØªÙ‡Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</div>
                </div>
                <span class="pill" id="prayersPill">0 / 5</span>
              </div>
              <input type="range" min="0" max="5" step="1" id="prayersRange" />
            </div>

            <div style="height:12px"></div>
            <div class="scaleBox">
              <div style="font-weight:900; margin-bottom:6px;">Ø¹Ù…Ù„ Ø®Ø§Øµ</div>
              <div class="hint" style="margin-bottom:10px;">Ù…Ù„Ø§Ø­Ø¸Ø© Ù‚ØµÙŠØ±Ø© Ù„Ù„ÙŠÙˆÙ… (Ù„Ø§ ØªØ¯Ø®Ù„ Ø¶Ù…Ù† Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²).</div>
              <textarea id="note" maxlength="140" placeholder="Ø§ÙƒØªØ¨ Ø¹Ù…Ù„Ùƒ Ø§Ù„Ø®Ø§Øµ Ù‡Ù†Ø§â€¦"></textarea>
            </div>

            <div style="height:12px"></div>
            <div class="navRow" style="grid-template-columns: 1fr 1fr 1fr;">
              <button class="btn primary" id="markAll">ØªØ£Ø´ÙŠØ± ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯</button>
              <button class="btn" id="clearDay">Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ…</button>
              <button class="btn danger" id="resetAll">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø´Ù‡Ø±</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="cardHead">
            <h2>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø´Ù‡Ø±</h2>
          </div>
          <div class="cardBody">
            <details open>
              <summary>Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</summary>
              <div class="inside" id="statsBox"></div>
            </details>
            <div style="height:10px"></div>
            <details>
              <summary>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø± (30 ÙŠÙˆÙ…)</summary>
              <div class="inside">
                <div class="tableWrap">
                  <table id="monthTable"></table>
                </div>
                <div class="hint" style="margin-top:8px;">Ù…Ø±Ù‘Ø± Ø£ÙÙ‚ÙŠÙ‹Ø§ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.</div>
              </div>
            </details>
          </div>
        </section>
      </div>

      <div class="footerNote">Ø¹Ù„Ù‰ iPhone: Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© â†’ "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©". Ø¹Ù„Ù‰ Android: â‹® â†’ "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚".
      </div>
    </div>
  </main>

  <div class="installBar" id="installBar">
    <div class="txt">
      <div class="t1">Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      <div class="t2">ÙŠÙØªØ­ ÙƒØªØ·Ø¨ÙŠÙ‚ Ù…Ø³ØªÙ‚Ù„ ÙˆÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª.</div>
    </div>
    <div class="actions">
      <button class="miniBtn" id="installLater">Ù„Ø§Ø­Ù‚Ù‹Ø§</button>
      <button class="miniBtn ok" id="installNow">ØªØ«Ø¨ÙŠØª</button>
    </div>
  </div>

  <div id="pdfModal" class="modal">
    <div class="modal-head">
      <span style="font-weight:900;">Ø²Ø§Ø¯ Ø§Ù„Ø°Ø§ÙƒØ±</span>
      <button class="close-btn" onclick="closeZad()">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
    </div>
    <div id="pdfContainer" class="pdf-container">
      <div class="pdf-loading">ğŸ“– Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø²Ø§Ø¯ Ø§Ù„Ø°Ø§ÙƒØ±</div>
    </div>
  </div>

  <script>
    // PWA: Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try { await navigator.serviceWorker.register("./sw.js"); } catch (e) { }
      });
    }

    // Install prompt (Android Chrome)
    let deferredPrompt = null;
    const installBar = document.getElementById("installBar");
    const installNow = document.getElementById("installNow");
    const installLater = document.getElementById("installLater");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBar.style.display = "flex";
    });

    installLater.addEventListener("click", () => { installBar.style.display = "none"; });
    installNow.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch (e) { }
      deferredPrompt = null;
      installBar.style.display = "none";
    });

    // Dates
    const PRESET_DATES = ["2026-02-18", "2026-02-19", "2026-02-20", "2026-02-21", "2026-02-22", "2026-02-23", "2026-02-24", "2026-02-25", "2026-02-26", "2026-02-27", "2026-02-28", "2026-03-01", "2026-03-02", "2026-03-03", "2026-03-04", "2026-03-05", "2026-03-06", "2026-03-07", "2026-03-08", "2026-03-09", "2026-03-10", "2026-03-11", "2026-03-12", "2026-03-13", "2026-03-14", "2026-03-15", "2026-03-16", "2026-03-17", "2026-03-18", "2026-03-19"];

    function formatArabicWeekday(d) {
      return new Intl.DateTimeFormat('ar', { weekday: 'long' }).format(d);
    }
    function formatArabicDate(d) {
      const day = d.getDate();
      const month = d.getMonth() + 1;
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    const TEMPLATE = {
      days: 30,
      habits: [
        { key: "morning_adhkar", label: "Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ <a href=\"javascript:void(0)\" class=\"zad-link\" style=\"color:var(--gold); font-weight:900; text-decoration:none;\">(Ø²Ø§Ø¯ Ø§Ù„Ø°Ø§ÙƒØ±)</a>" },
        { key: "duha_prayer", label: "ØµÙ„Ø§Ø© Ø§Ù„Ø¶Ø­Ù‰" },
        { key: "kinship", label: "ØµÙ„Ø© Ø§Ù„Ø±Ø­Ù…" },
        { key: "quran_juz", label: "Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø±Ø¢Ù†" },
        { key: "sadaqah", label: "ØµØ¯Ù‚Ø©" },
        { key: "dhikr_200", label: "Ø§Ù„Ø°ÙƒØ± 300 Ù…Ø±Ø© ( 100 Ø§Ø³ØªØºÙØ§Ø± ØŒ 100 ØªÙ‡Ù„ÙŠÙ„ ØŒ 100 ØµÙ„Ø§Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ³Ù„Ù… )" },
        { key: "rawatib", label: "Ø§Ù„Ø³Ù†Ù† Ø§Ù„Ø±ÙˆØ§ØªØ¨" },
        { key: "dua", label: "Ø§Ù„Ø¯Ø¹Ø§Ø¡" },
        { key: "evening_adhkar", label: "Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡ <a href=\"javascript:void(0)\" class=\"zad-link\" style=\"color:var(--gold); font-weight:900; text-decoration:none;\">(Ø²Ø§Ø¯ Ø§Ù„Ø°Ø§ÙƒØ±)</a>" },
        { key: "taraweeh", label: "ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­" },
        { key: "witr", label: "ØµÙ„Ø§Ø© Ø§Ù„ÙˆØªØ±" },
        { key: "surah_mulk", label: "Ù‚Ø±Ø§Ø¡Ø© Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ" },
        { key: "before_sleep_adhkar", label: "Ø£Ø°ÙƒØ§Ø± Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…" }
      ]
    };

    const STORAGE_KEY = "ramadan_pwa_state_v1";
    const UI_KEY = "ramadan_pwa_ui_v1";

    function emptyDay() {
      const day = { prayers: 0, note: "" };
      TEMPLATE.habits.forEach(h => day[h.key] = false);
      return day;
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        const init = {};
        for (let d = 1; d <= TEMPLATE.days; d++) init[d] = emptyDay();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
        return init;
      }
      try {
        const st = JSON.parse(raw);
        for (let d = 1; d <= TEMPLATE.days; d++) if (!st[d]) st[d] = emptyDay();
        return st;
      } catch (e) {
        const init = {};
        for (let d = 1; d <= TEMPLATE.days; d++) init[d] = emptyDay();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
        return init;
      }
    }
    function saveState(st) { localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }

    function loadUI() {
      const raw = localStorage.getItem(UI_KEY);
      if (!raw) return { currentDay: 1 };
      try { return JSON.parse(raw); } catch (e) { return { currentDay: 1 }; }
    }
    function saveUI(ui) { localStorage.setItem(UI_KEY, JSON.stringify(ui)); }

    function calcDayScore(dayData) {
      const totalBool = TEMPLATE.habits.length;
      const doneBool = TEMPLATE.habits.reduce((a, h) => a + (dayData[h.key] ? 1 : 0), 0);
      const prayersNorm = Math.max(0, Math.min(1, (Number(dayData.prayers || 0) / 5)));
      const totalUnits = totalBool + 1;
      const doneUnits = doneBool + prayersNorm;
      const pct = Math.round((doneUnits / totalUnits) * 100);
      const complete = (doneBool === totalBool) && (Number(dayData.prayers || 0) === 5);
      const partial = (doneBool > 0) || (Number(dayData.prayers || 0) > 0);
      return { pct, complete, partial, doneBool, totalBool };
    }

    const state = loadState();
    const ui = loadUI();

    const el = {
      prevDay: document.getElementById("prevDay"),
      nextDay: document.getElementById("nextDay"),
      itemsList: document.getElementById("itemsList"),
      prayersRange: document.getElementById("prayersRange"),
      prayersPill: document.getElementById("prayersPill"),
      note: document.getElementById("note"),
      markAll: document.getElementById("markAll"),
      clearDay: document.getElementById("clearDay"),
      resetAll: document.getElementById("resetAll"),
      statusBadge: document.getElementById("statusBadge"),
      boolBadge: document.getElementById("boolBadge"),
      prayersBadge: document.getElementById("prayersBadge"),
      ramadanChip: document.getElementById("ramadanChip"),
      gregChip: document.getElementById("gregChip"),
      scoreChip: document.getElementById("scoreChip"),
      dayTitle: document.getElementById("dayTitle"),
      dayDate: document.getElementById("dayDate"),
      statsBox: document.getElementById("statsBox"),
      monthTable: document.getElementById("monthTable")
    };

    function clampDay(n) { return Math.max(1, Math.min(TEMPLATE.days, n)); }

    function getDayDate(dayNum) {
      const iso = PRESET_DATES[dayNum - 1];
      const d = new Date(iso + "T00:00:00");
      const weekday = formatArabicWeekday(d);
      const dmy = formatArabicDate(d);
      return { iso, d, weekday, dmy };
    }

    function setStatus(score) {
      el.statusBadge.className = "badge";
      if (score.complete) { el.statusBadge.textContent = "Ù…ÙƒØªÙ…Ù„"; el.statusBadge.classList.add("ok"); }
      else if (score.partial) { el.statusBadge.textContent = "Ø¬Ø²Ø¦ÙŠ"; el.statusBadge.classList.add("warn"); }
      else { el.statusBadge.textContent = "ØºÙŠØ± Ù…ÙƒØªÙ…Ù„"; el.statusBadge.classList.add("miss"); }
    }

    // Sanitize HTML labels â€” preserve class for event delegation
    function sanitizeLabel(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      const links = tmp.querySelectorAll("a");
      links.forEach(a => {
        const href = a.getAttribute("href");
        const cls = a.getAttribute("class") || "";
        const safeLink = document.createElement("a");
        safeLink.href = cls.includes("zad-link") ? "javascript:void(0)" : (href || "#");
        if (cls) safeLink.className = cls;
        if (!cls.includes("zad-link")) { safeLink.target = "_blank"; safeLink.rel = "noopener"; }
        safeLink.style.cssText = "color:var(--gold); font-weight:900; text-decoration:none; cursor:pointer;";
        safeLink.textContent = a.textContent;
        a.replaceWith(safeLink);
      });
      return tmp.innerHTML;
    }

    // PDF Viewer Logic (using PDF.js for cross-device support)
    const PDF_LOCAL = "./zad.pdf";
    const modal = document.getElementById("pdfModal");
    const pdfContainer = document.getElementById("pdfContainer");
    let pdfLoaded = false;

    // Configure PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    async function openZad() {
      modal.classList.add("open");

      // Only load once
      if (pdfLoaded) return;

      pdfContainer.innerHTML = '<div class="pdf-loading">ğŸ“– Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø²Ø§Ø¯ Ø§Ù„Ø°Ø§ÙƒØ±...</div>';

      try {
        const res = await fetch(PDF_LOCAL);
        if (!res.ok) throw new Error("Not found");
        const arrayBuf = await res.arrayBuffer();

        // Cache for offline
        if ('caches' in window) {
          try {
            const cache = await caches.open("zad-cache-v1");
            cache.put("zad-pdf", new Response(arrayBuf.slice(0), { headers: { "Content-Type": "application/pdf" } }));
          } catch (e) { }
        }

        // Render with PDF.js
        const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
        pdfContainer.innerHTML = "";

        const containerWidth = pdfContainer.clientWidth - 8;

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const baseViewport = page.getViewport({ scale: 1 });
          const scale = Math.min(1.5, containerWidth / baseViewport.width);
          const viewport = page.getViewport({ scale });

          const canvas = document.createElement("canvas");
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          const ctx = canvas.getContext("2d");
          await page.render({ canvasContext: ctx, viewport }).promise;
          pdfContainer.appendChild(canvas);
        }

        pdfLoaded = true;
      } catch (e) {
        // Try from cache if fetch fails (offline)
        try {
          const cache = await caches.open("zad-cache-v1");
          const cached = await cache.match("zad-pdf");
          if (cached) {
            const buf = await cached.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
            pdfContainer.innerHTML = "";
            const containerWidth = pdfContainer.clientWidth - 8;
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const baseViewport = page.getViewport({ scale: 1 });
              const scale = Math.min(1.5, containerWidth / baseViewport.width);
              const viewport = page.getViewport({ scale });
              const canvas = document.createElement("canvas");
              canvas.width = viewport.width;
              canvas.height = viewport.height;
              await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
              pdfContainer.appendChild(canvas);
            }
            pdfLoaded = true;
          } else {
            throw new Error("No cache");
          }
        } catch (e2) {
          pdfContainer.innerHTML = '<div class="pdf-loading" style="color:red;">â— ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</div>';
        }
      }
    }

    function closeZad() {
      modal.classList.remove("open");
    }

    // Event delegation: catch all .zad-link clicks globally
    document.addEventListener("click", (e) => {
      const link = e.target.closest(".zad-link");
      if (link) {
        e.preventDefault();
        openZad();
      }
    });

    function renderDay() {
      ui.currentDay = clampDay(ui.currentDay || 1);
      saveUI(ui);

      const dayNum = ui.currentDay;
      const dayData = state[dayNum];
      const score = calcDayScore(dayData);
      const dd = getDayDate(dayNum);

      el.ramadanChip.textContent = `${dayNum} Ø±Ù…Ø¶Ø§Ù†`;
      el.gregChip.textContent = `${dd.weekday} ${dd.dmy}`;
      el.scoreChip.textContent = `${score.pct}%`;

      el.dayTitle.textContent = `Ø§Ù„ÙŠÙˆÙ… ${dayNum} Ø±Ù…Ø¶Ø§Ù†`;
      el.dayDate.textContent = `${dd.weekday} â€¢ ${dd.dmy}`;

      setStatus(score);
      el.boolBadge.textContent = `${score.doneBool} / ${score.totalBool}`;
      el.prayersBadge.textContent = `Ø§Ù„ØµÙ„Ø§Ø©: ${Number(dayData.prayers || 0)}/5`;

      el.prevDay.disabled = dayNum <= 1;
      el.nextDay.disabled = dayNum >= TEMPLATE.days;

      el.itemsList.innerHTML = "";
      TEMPLATE.habits.forEach(h => {
        const wrap = document.createElement("div");
        wrap.className = "item";

        const meta = document.createElement("div");
        meta.className = "meta";
        const lab = document.createElement("label");
        lab.innerHTML = sanitizeLabel(h.label);
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ØªØ£Ø´ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØªÙ…Ø§Ù…";
        meta.appendChild(lab);
        meta.appendChild(hint);

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!dayData[h.key];
        cb.addEventListener("change", () => {
          dayData[h.key] = cb.checked;
          saveState(state);
          renderDay();
          renderStats();
          renderMonthTable();
        });

        wrap.appendChild(meta);
        wrap.appendChild(cb);
        el.itemsList.appendChild(wrap);
      });

      el.prayersRange.value = Number(dayData.prayers || 0);
      el.prayersPill.textContent = `${Number(dayData.prayers || 0)} / 5`;
      el.prayersRange.oninput = () => {
        dayData.prayers = Number(el.prayersRange.value);
        el.prayersPill.textContent = `${dayData.prayers} / 5`;
        saveState(state);
        const sc = calcDayScore(dayData);
        el.scoreChip.textContent = `${sc.pct}%`;
        setStatus(sc);
        el.boolBadge.textContent = `${sc.doneBool} / ${sc.totalBool}`;
        el.prayersBadge.textContent = `Ø§Ù„ØµÙ„Ø§Ø©: ${dayData.prayers}/5`;
        renderStats();
        renderMonthTable();
      };

      el.note.value = dayData.note || "";
      el.note.oninput = () => {
        dayData.note = el.note.value;
        saveState(state);
        renderMonthTable();
      };
    }

    function renderStats() {
      let completed = 0, partial = 0, zero = 0;
      let avg = 0;
      let prayersFull = 0;

      for (let d = 1; d <= TEMPLATE.days; d++) {
        const sc = calcDayScore(state[d]);
        avg += sc.pct;
        if (sc.complete) completed++;
        else if (sc.partial) partial++;
        else zero++;
        if (Number(state[d].prayers || 0) === 5) prayersFull++;
      }
      avg = Math.round(avg / TEMPLATE.days);

      const per = TEMPLATE.habits.map(h => {
        let c = 0;
        for (let d = 1; d <= TEMPLATE.days; d++) if (state[d][h.key]) c++;
        return { label: h.label, count: c };
      }).sort((a, b) => b.count - a.count);

      el.statsBox.innerHTML = `
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
        <span class="badge ok">Ø£ÙŠØ§Ù… Ù…ÙƒØªÙ…Ù„Ø©: ${completed}</span>
        <span class="badge warn">Ø£ÙŠØ§Ù… Ø¬Ø²Ø¦ÙŠØ©: ${partial}</span>
        <span class="badge miss">Ø£ÙŠØ§Ù… Ø¨Ù„Ø§ Ø¥Ù†Ø¬Ø§Ø²: ${zero}</span>
        <span class="badge">Ù…ØªÙˆØ³Ø·: ${avg}%</span>
        <span class="badge">Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØµÙ„Ø§Ø© (5/5): ${prayersFull} ÙŠÙˆÙ…</span>
      </div>
      <div class="hint" style="margin-bottom:8px;">Ø£ÙƒØ«Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªØ²Ø§Ù…Ù‹Ø§ (Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…):</div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        ${per.slice(0, 8).map(x => `
          <div class="item" style="padding:10px 12px;">
            <div class="meta">
              <label>${stripHtml(x.label)}</label>
              <div class="hint">${x.count} / ${TEMPLATE.days}</div>
            </div>
            <span class="pill">${Math.round((x.count / TEMPLATE.days) * 100)}%</span>
          </div>
        `).join("")}
      </div>
    `;
    }

    // FIX #3: Strip HTML tags for clean text display in table and stats
    function stripHtml(str) {
      const tmp = document.createElement("div");
      tmp.innerHTML = str;
      return tmp.textContent || tmp.innerText || "";
    }

    function renderMonthTable() {
      let thead = "<thead><tr><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>";
      TEMPLATE.habits.forEach(h => thead += `<th>${escapeHtml(stripHtml(h.label))}</th>`);
      thead += "<th>Ø§Ù„ØµÙ„Ø§Ø©</th><th>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th></tr></thead>";

      let tbody = "<tbody>";
      for (let d = 1; d <= TEMPLATE.days; d++) {
        const dd = getDayDate(d);
        const sc = calcDayScore(state[d]);
        const cls = sc.complete ? "ok" : (sc.partial ? "warn" : "miss");

        tbody += `<tr>
        <td><strong>${d} Ø±Ù…Ø¶Ø§Ù†</strong></td>
        <td>${escapeHtml(dd.weekday)} ${escapeHtml(dd.dmy)}</td>
      `;
        TEMPLATE.habits.forEach(h => {
          tbody += `<td>${state[d][h.key] ? "âœ“" : ""}</td>`;
        });
        tbody += `<td>${Number(state[d].prayers || 0)}/5</td>`;
        tbody += `<td><span class="badge ${cls}">${sc.pct}%</span></td></tr>`;
      }
      tbody += "</tbody>";

      el.monthTable.innerHTML = thead + tbody;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    el.prevDay.addEventListener("click", () => { ui.currentDay = clampDay(ui.currentDay - 1); renderDay(); });
    el.nextDay.addEventListener("click", () => { ui.currentDay = clampDay(ui.currentDay + 1); renderDay(); });

    el.markAll.addEventListener("click", () => {
      const d = ui.currentDay;
      TEMPLATE.habits.forEach(h => state[d][h.key] = true);
      saveState(state);
      renderDay(); renderStats(); renderMonthTable();
    });

    el.clearDay.addEventListener("click", () => {
      const d = ui.currentDay;
      state[d] = emptyDay();
      saveState(state);
      renderDay(); renderStats(); renderMonthTable();
    });

    el.resetAll.addEventListener("click", () => {
      const ok = confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
      if (!ok) return;
      for (let d = 1; d <= TEMPLATE.days; d++) state[d] = emptyDay();
      saveState(state);
      ui.currentDay = 1;
      saveUI(ui);
      renderDay(); renderStats(); renderMonthTable();
    });

    ui.currentDay = clampDay(ui.currentDay || 1);
    saveUI(ui);
    renderDay();
    renderStats();
    renderMonthTable();
  </script>
</body>

</html>